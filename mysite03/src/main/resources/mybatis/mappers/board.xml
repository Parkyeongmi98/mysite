<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="board">
	<!-- 게시판 리스트 -->
	<select id="findAllByPageAndKeyword" resultType="boardvo" parameterType="map">
		<choose>
			<when test='keyword == null or keyword == ""'>
				<![CDATA[
				select a.no, a.title, a.contents, a.hit, a.reg_date, b.name as userName, a.depth 
					from board a, user b
					where a.user_no = b.no
					order by a.g_no desc, a.o_no asc
					limit #{startOffset }, #{size }
				]]>
			</when>
			<otherwise>
				<![CDATA[
				select a.no, a.title, a.contents, a.hit, a.reg_date, b.name as userName, a.depth 
					from board a, user b
					where a.user_no = b.no
					and a.title like '%${keyword }%'
					or a.contents like '%${keyword }%'
					order by a.g_no desc, a.o_no asc
					limit #{startOffset }, #{size }
				]]>
			</otherwise>
		</choose>
	</select>
	
	<!-- 게시판 총 개수 -->
	<select id="getTotalCount" parameterType="string" resultType="integer">
		<choose>
			<when test='_parameter == null or _parameter == ""'>
				<![CDATA[
				select count(*)
					from board
				]]>
			</when>
			<otherwise>
				<![CDATA[
				select count(*)
					from board
					where title like '%${_parameter }%'
					or contents like '%${_parameter }%'
				]]>
			</otherwise>
		</choose>
	</select>
	
	<!-- 게시판 상세보기 -->
	<select id="getContentsNo" resultType="boardvo" parameterType="long">
		<![CDATA[
		select a.no, a.title, a.contents, a.g_no as groupNo, a.o_no as orderNo, a.depth, a.user_no as userNo, b.name as userName
			from board a, user b
			where a.user_no = b.no
			and a.no = #{no }
		]]>
	</select>
	
	<select id="getContentsNoandUserNo" resultType="boardvo" parameterType="map">
		<![CDATA[
		select a.no, a.title, a.contents, a.g_no as groupNo, a.o_no as orderNo, a.depth, a.user_no as userNo, b.name as userName
			from board a, user b
			where a.user_no = b.no
			and a.no = #{no }
			and user_no = #{userNo }
		]]>
	</select>
	
	<!-- 게시판글 등록하기 -->
	<insert id="insertContents" parameterType="boardvo">
		<![CDATA[
		insert into board
		values(null, #{title }, #{contents }, 0, now(), #{groupNo }, #{orderNo }, #{depth }, #{userNo })
		]]>
	</insert>
	
	<!-- max g_no 찾기 -->
	<select id="findMaxNo" resultType="long">
		<![CDATA[
		select max(g_no)
			from board
		]]>
	</select>
	
	<!-- 댓글 g_no, o_no 업데이트하기 -->
	<update id="updateGroupNo" parameterType="map">
		<![CDATA[
		update board
			set o_no = o_no + 1
			where g_no = #{groupNo }
			and o_no > #{orderNo }
		]]>
	</update>

	<!-- 게시판 수정하기 -->
	<update id="updateContents" parameterType="boardvo">
		<![CDATA[
		update board
			set title = #{title }, contents = #{contents }
			where no = #{no }
		]]>
	</update>
	
	<!-- 게시글 삭제하기 -->
	<delete id="deleteContents" parameterType="map">
		<![CDATA[
		delete 
			from board 
			where no = #{no }
			and user_no =#{userNo }
		]]>
	</delete>
	
	<!-- 조회수 -->
	<update id="visitCount" parameterType="long">
		<![CDATA[
		update board
			set hit = hit + 1
			where no = #{no }
		]]>
	</update>
</mapper>